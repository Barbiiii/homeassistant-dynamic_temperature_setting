blueprint:
  name: Heizung - Negativer Turbo Offset (Ganzzahl-Fix)
  description: Nutzt nur ganze Zahlen für den Offset und erzwingt mindestens -1 bei Heizbedarf.
  domain: automation
  input:
    climate_entity:
      name: Heizungsthermostat
      selector:
        entity:
          domain: climate
    offset_entity:
      name: Offset-Entität (Number)
      selector:
        entity:
          domain: number
    temp_sensor_entity:
      name: Externer Temperatursensor
      selector:
        entity:
          domain: sensor
    wunsch_temp_entity:
      name: Wunschtemperatur (Helper)
      selector:
        entity:
          domain: input_number
    window_sensor_entity:
      name: Fenster-/Türsensor (Optional)
      default: none
      selector:
        entity:
          domain: binary_sensor

trigger:
  - platform: state
    entity_id: !input temp_sensor_entity
  - platform: state
    entity_id: !input wunsch_temp_entity

mode: restart

action:
  - variables:
      climate_ent: !input climate_entity
      offset_ent: !input offset_entity
      temp_sensor_ent: !input temp_sensor_entity
      wunsch_temp_ent: !input wunsch_temp_entity
      
      ist_extern: "{{ states(temp_sensor_ent) | float(20.0) }}"
      ist_intern_anzeige: "{{ state_attr(climate_ent, 'current_temperature') | float(20.0) }}"
      aktueller_offset: "{{ states(offset_ent) | float(0.0) }}"
      wunsch_temp: "{{ states(wunsch_temp_ent) | float(20.0) }}"
      
      # 1. Rohwert (Was das Ventil ohne Korrektur misst)
      ist_intern_roh: "{{ ist_intern_anzeige - aktueller_offset }}"
      
      # 2. Wunsch-Differenz
      wunsch_diff: "{{ (wunsch_temp - ist_extern) | float }}"
      
      # 3. Berechnung des neuen Offsets (Ganzzahlig)
      # Wir berechnen den theoretischen Wert: (Messfehler - Wunsch-Differenz)
      theo_offset: "{{ (ist_extern - ist_intern_roh) - wunsch_diff }}"
      
      # 4. Logik-Entscheidung:
      # Wenn wir heizen wollen (diff > 0), nehmen wir den berechneten Wert 
      # (gerundet) ODER mindestens -1.
      neuer_offset: >
        {% if wunsch_diff > 0.1 %}
          {{ [ (theo_offset | round(0, method='floor') | int), -1 ] | min }}
        {% else %}
          0
        {% endif %}

  # Fenster-Check
  - if:
      - condition: template
        value_template: >
          {% set win = !input window_sensor_entity %}
          {{ win != 'none' and is_state(win, 'on') }}
    then:
      - stop: "Abbruch: Fenster offen."

  # Offset setzen (Hysterese 1.0, da nur ganze Zahlen möglich)
  - if:
      - condition: template
        value_template: "{{ (aktueller_offset | int - neuer_offset | int) | abs >= 1 }}"
    then:
      - service: number.set_value
        target:
          entity_id: "{{ offset_ent }}"
        data:
          value: "{{ neuer_offset | clamp(-10, 0) }}"
      - delay: "00:00:05"

  - service: climate.set_temperature
    target:
      entity_id: "{{ climate_ent }}"
    data:
      temperature: "{{ wunsch_temp }}"
