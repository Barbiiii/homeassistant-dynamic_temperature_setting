blueprint:
  name: Heizung - Aggressiver Boost-Modus
  description: Schaltet kurzzeitig auf 30Â°C, um das Ventil zu erzwingen, wenn der Offset allein nicht reicht.
  domain: automation
  input:
    climate_entity:
      name: Heizungsthermostat
      selector:
        entity:
          domain: climate
    offset_entity:
      name: Offset-EntitÃ¤t (Number)
      selector:
        entity:
          domain: number
    temp_sensor_entity:
      name: Externer Temperatursensor
      selector:
        entity:
          domain: sensor
    wunsch_temp_entity:
      name: Wunschtemperatur (Helper)
      selector:
        entity:
          domain: input_number

trigger:
  - platform: state
    entity_id: !input temp_sensor_entity
  - platform: state
    entity_id: !input wunsch_temp_entity

mode: restart

action:
  - variables:
      climate_ent: !input climate_entity
      offset_ent: !input offset_entity
      temp_sensor_ent: !input temp_sensor_entity
      wunsch_temp_ent: !input wunsch_temp_entity
      
      ist_extern: "{{ states(temp_sensor_ent) | float(20.0) }}"
      ist_intern_anzeige: "{{ state_attr(climate_ent, 'current_temperature') | float(20.0) }}"
      aktueller_offset: "{{ states(offset_ent) | float(0.0) }}"
      wunsch_temp: "{{ states(wunsch_temp_ent) | float(20.0) }}"
      
      ist_intern_roh: "{{ ist_intern_anzeige - aktueller_offset }}"
      diff: "{{ wunsch_temp - ist_extern }}"
      
      # Wir setzen den Offset wie besprochen auf einen festen, starken negativen Wert
      neuer_offset: "{{ ((ist_extern - ist_intern_roh) - 2.0) | round(0, 'floor') | int }}"

  # 1. Offset setzen
  - service: number.set_value
    target:
      entity_id: "{{ offset_ent }}"
    data:
      value: "{{ neuer_offset | clamp(-10, 0) | int }}"

  # 2. BOOST-LOGIK:
  # Wenn die Differenz > 0.5 Grad ist, schicken wir kurz 30 Grad als Befehl,
  # um das Ventil "aufzuwecken", und setzen dann die echte Wunschtemperatur.
  - if:
      - condition: template
        value_template: "{{ diff > 0.5 }}"
    then:
      - service: climate.set_temperature
        target:
          entity_id: "{{ climate_ent }}"
        data:
          temperature: 30
      - delay: "00:00:10" # Kurz warten, damit das Ventil den Befehl schluckt
      - service: climate.set_temperature
        target:
          entity_id: "{{ climate_ent }}"
        data:
          temperature: "{{ wunsch_temp }}"
    else:
      - service: climate.set_temperature
        target:
          entity_id: "{{ climate_ent }}"
        data:
          temperature: "{{ wunsch_temp }}"
