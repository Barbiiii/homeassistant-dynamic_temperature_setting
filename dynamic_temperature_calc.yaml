blueprint:
  name: Klimaanlage - Dynamische Temperaturanpassung (Faktor)
  description: Passt die Soll-Temperatur einer Klimaanlage/Heizung dynamisch basierend auf einem externen Temperatursensor an. Nutzt einen einstellbaren Korrekturfaktor.
  domain: automation
  input:
    climate_entity:
      name: Klimaanlage/Heizung
      description: Die Entität (z.B. climate.schlafi_c931), deren Temperatur geregelt wird.
      selector:
        entity:
          domain: climate
    temp_sensor_entity:
      name: Temperatursensor (Ist-Temperatur)
      description: Der externe Temperatursensor (z.B. sensor.lumi_temperatur).
      selector:
        entity:
          domain: sensor
    wunsch_temp_entity:
      name: Wunschtemperatur (Input-Helper)
      description: Der input_number-Helfer, der die gewünschte Temperatur speichert.
      selector:
        entity:
          domain: input_number
    korrektur_faktor:
      name: Korrekturfaktor (z.B. 3.0)
      description: Additive Korrektur zur Temperaturdifferenz (Diff + Faktor). Höherer Wert = aggressiveres Heizen.
      default: 3.0
      selector:
        number:
          min: 0.5
          max: 10.0
          unit_of_measurement: "°C"
          mode: box
    window_sensor_entity:
      name: Fenster-/Türsensor (Lüftungsprüfung)
      description: Optionaler Sensor, der prüft, ob gelüftet wird. Automatisierung stoppt, wenn Sensor offen ist (state 'on'). Leer lassen, um die Prüfung zu ignorieren.
      selector:
        entity:
          domain: binary_sensor
      default: ''

trigger:
  - platform: state
    entity_id: !input temp_sensor_entity
  - platform: state
    entity_id: !input wunsch_temp_entity

action:
  - if: '{{ iif(is_state(''!input window_sensor_entity'', ''on''), true, false) }}'
    then:
      - stop: "Fenster/Tür ist offen, Automatisierung wird gestoppt."

  - variables:
      climate_ent: !input climate_entity
      temp_sensor_ent: !input temp_sensor_entity
      wunsch_temp_ent: !input wunsch_temp_entity
      
      faktor_value: !input korrektur_faktor 
      
      wunsch_temp: "{{ states(wunsch_temp_ent) | float(0) }}"
      ist_temp: "{{ states(temp_sensor_ent) | float(0) }}"
      
      max_solltemp: 30.0
      
      delta_fuer_heizen: >
        {% set faktor = faktor_value | float(3.0) %}
        {% set wunsch = wunsch_temp | float(0) %}
        {% set ist = ist_temp | float(0) %}
        {% set temp_diff = wunsch - ist %}
        
        {% if ist < (wunsch - 0.25) %}
            {% set raw_additive_delta = temp_diff + faktor %}
            {{ raw_additive_delta | round(1) }}
        
        {% elif ist < (wunsch + 0.25) %}
            {% set raw_additive_delta = temp_diff + faktor %}
            {% if ist < wunsch %}
                {{ (raw_additive_delta + 0.5) | round(1) }}
            {% else %}
                {{ raw_additive_delta | round(1) }}
            {% endif %}

        {% else %}
            -1.0
        {% endif %}
          
      neue_solltemp: >
        {% set ungefilterte_solltemp = wunsch_temp | float(0) + delta_fuer_heizen | float(0) %}
        {% set temp_mal_zwei = ungefilterte_solltemp * 2 %}
        {% set aufgerundet = temp_mal_zwei | round(0, 'ceil') %}
        {% set gerundet_final = aufgerundet / 2 %}
        {{ [max_solltemp, gerundet_final] | min | round(1) }}
        
      aktuelle_solltemp: "{{ state_attr(climate_ent, 'temperature') | float(0) }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ ist_temp | float(0) > (wunsch_temp | float(0) + 0.25) }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: '{{ climate_ent }}'
            data:
              hvac_mode: fan_only
          - service: climate.set_fan_mode
            target:
              entity_id: '{{ climate_ent }}'
            data:
              fan_mode: low

    default:
      - service: climate.set_hvac_mode
        target:
          entity_id: '{{ climate_ent }}'
        data:
          hvac_mode: heat
      - service: climate.set_temperature
        target:
          entity_id: '{{ climate_ent }}'
        data:
          temperature: "{{ neue_solltemp }}" 
          hvac_mode: heat
      - service: climate.set_fan_mode
        target:
          entity_id: '{{ climate_ent }}'
        data:
          fan_mode: mid
