blueprint:
  name: Klimaanlage - Dynamische Temperatutanpassung
  description: Passt die Soll-Temperatur einer Klimaanlage/Heizung dynamisch basierend auf einem externen Temperatursensor an. Nutzt Korrekturfaktor und wählbare Lüfterstufen für verschiedene Zustände.
  domain: automation
  input:
    climate_entity:
      name: Klimaanlage/Heizung
      description: Die Entität (z.B. climate.schlafi_c931), deren Temperatur geregelt wird.
      selector:
        entity:
          domain: climate
    temp_sensor_entity:
      name: Temperatursensor (Ist-Temperatur)
      description: Der externe Temperatursensor (z.B. sensor.lumi_temperatur).
      selector:
        entity:
          domain: sensor
    wunsch_temp_entity:
      name: Wunschtemperatur (Input-Helper)
      description: Der input_number-Helfer, der die gewünschte Temperatur speichert.
      selector:
        entity:
          domain: input_number
    korrektur_faktor:
      name: Korrekturfaktor (z.B. 3.0)
      description: Additive Korrektur zur Temperaturdifferenz (Diff + Faktor). Höherer Wert = aggressiveres Heizen.
      default: 3.0
      selector:
        number:
          min: 0.5
          max: 10.0
          unit_of_measurement: "°C"
          mode: box
    window_sensor_entity:
      name: Fenster-/Türsensor (Lüftungsprüfung)
      description: Optionaler Sensor, der prüft, ob gelüftet wird. Automatisierung stoppt, wenn Sensor offen ist (state 'on'). Leer lassen, um die Prüfung zu ignorieren.
      selector:
        entity:
          domain: binary_sensor
      default: ''
    fan_mode_heat_standard:
      name: Standard Lüfterstärke Heizen
      description: Lüfterstufe, wenn Heizen Erforderlich ist.
      default: Mid
      selector:
        select:
          options:
            - Low
            - LowMid
            - Mid
            - MidHigh
            - High
    fan_mode_heat_increased:
      name: Erhöhte Lüfterstärke Heizen
      description: Wenn dieser Wert gesetzt ist, wird er im Bereich -0,5 °C und + 0,25 °C um die Wunschtemperatur eingesetzt.
      default: null
      selector:
        select:
          options:
            - Low
            - LowMid
            - Mid
            - MidHigh
            - High
    fan_mode_vent:
      name: Lüfterstärke bei Lüftung
      description: Lüfterstufe, die verwendet wird, wenn die Klimaanlage auf Nur Lüftung wechselt, um den Raum abzukühlen.
      default: Low
      selector:
        select:
          options:
            - Auto
            - Low
            - LowMid
            - Mid
            - MidHigh
            - High
    fan_mode_decreased_entity:
      name: Auswahl für abweichende Lüfterstärke beim Heizen
      description: Auswahl für eine abweichende, die zeitgesteuert gesetzt werden kann.
      selector:
        entity:
          domain: input_select
    
trigger:
  - platform: state
    entity_id: !input temp_sensor_entity
  - platform: state
    entity_id: !input wunsch_temp_entity
action:
  - if:
      - condition: state
        entity_id: !input window_sensor_entity
        state: "on"
    then:
      - stop: "Fenster/Tür ist offen, Automatisierung wird gestoppt."
  - variables:
      climate_ent: !input climate_entity
      temp_sensor_ent: !input temp_sensor_entity
      wunsch_temp_ent: !input wunsch_temp_entity
      fan_decreased_ent: !input fan_mode_decreased_entity
      fan_standard: !input fan_mode_heat_standard
      fan_increased: !input fan_mode_heat_increased
      fan_vent: !input fan_mode_vent
      faktor_value: !input korrektur_faktor
      wunsch_temp: "{{ states(wunsch_temp_ent) | float(0) }}"
      ist_temp: "{{ states(temp_sensor_ent) | float(0) }}"
      temp_diff: "{{ (wunsch_temp - ist_temp) }}"
      max_solltemp: 30.0
      fan_mode_decreased: "{{ states(fan_decreased_ent) | string() }}"
      is_aggressive_heating: >
       {{ ist_temp > (wunsch_temp - 1) and ist_temp <= (wunsch_temp + 0.5) }}
      faktor: >
       {% set base_faktor = faktor_value | float(1.0) %}
       {% if is_aggressive_heating %}
         {{ (base_faktor + 1) | round(1) }}
       {% else %}
         {{ base_faktor | round(1) }}
       {% endif %}
      neue_solltemp: >
       {% set temp_mal_zwei = (wunsch_temp + temp_diff) * 2 %}
       {% set aufgerundet = temp_mal_zwei | round(0, 'ceil') %}
       {% set gerundet_final = aufgerundet / 2 %}
       {{ ([max_solltemp, gerundet_final] | min | round(1)) + faktor | float(0) }}
      fan_to_use: >
       {{ fan_mode_decreased if fan_mode_decreased != 'Standard'
       else (fan_increased if is_aggressive_heating else fan_standard) }}

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ false }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: '{{ climate_ent }}'
            data:
              hvac_mode: fan_only
          - service: climate.set_fan_mode
            target:
              entity_id: '{{ climate_ent }}'
            data:
              fan_mode: '{{ fan_vent }}'
    default:
        - service: climate.set_hvac_mode
          target:
            entity_id: '{{ climate_ent }}'
          data:
              hvac_mode: heat_cool
        - service: climate.set_temperature
          target:
            entity_id: '{{ climate_ent }}'
          data:
            temperature: "{{ neue_solltemp }}" 
            hvac_mode: heat
        - service: climate.set_fan_mode
          target:
            entity_id: '{{ climate_ent }}'
          data:
            fan_mode: '{{ fan_to_use }}'
